<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="bootstrap/bootstrap-icons-1.9.1/bootstrap-icons.css">
    <link rel="stylesheet" href="css/style.css">
    <script src="bootstrap/js/bootstrap.bundle.min.js"></script>
    <title>Image management</title>
</head>
<body>
    <div class="container">
        <div class="row">
          <div class="col">
            <h1>Image-Generator</h1>
          </div>
        </div>
        <div class="row">
            <div class="col">
                <form id="imageForm" method="POST" action="{{ url }}" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="formFile" class="form-label">Background-Image</label>
                        <input class="form-control" type="file" id="backgroundFileLoader" name="background">
                    </div>
                    <div class="mb-3">
                        <label for="formFile" class="form-label">GIF-Image</label>
                        <input class="form-control" type="file" id="gifImageLoader" name="gif">
                    </div>
                    <input type="hidden" id="gifStartingX" name="gif_starting_x">
                    <input type="hidden" id="gifStartingY" name="gif_starting_y">
                </form>
            </div>
          </div>
          <div class="row">
            <div class="col">
                <button type="button" class="btn btn-primary" onclick="generateImg()" id="generate">Generate</button>
            </div>
          </div>
          <div class="row">
            <div class="col">
                <img src="" id="backgroundImage" class="image img-fluid"/>
                <img src="" id="gif" class="image">
            </div>
          </div>
          <div class="row">
            <div class="col">
                <div class="card info-card">
                    <div class="card-body">
                        <i class="bi bi-info-circle"></i>
                        Left click on an image to start moving it and left click again on the image to place it
                    </div>
                  </div>
            </div>
          </div>
      </div>
<!--
    <form id="imageForm" method="POST" action="{{ url }}" enctype="multipart/form-data">
        Background image : <input type="file" id="backgroundFileLoader" name="background"> <br>
        Gif image : <input type="file" id="gifImageLoader" name="gif"> <br>
        <input type="hidden" id="gifStartingX" name="gif_starting_x"> <br>
        <input type="hidden" id="gifStartingY" name="gif_starting_y"> <br>
        <input type="submit" value="Generate">
    </form>
    Left click on an image to start moving it and left click again on the image to place it <br>
    <img src="" id="backgroundImage" class="image"/>
    <img src="" id="gif" class="image">
-->
</body>

<script>
    document.addEventListener("DOMContentLoaded", function (){
        // Initialize background image and gif image
        var backgroundImage = document.getElementById("backgroundImage");
        var gifImage = document.getElementById("gif");

        backgroundImage.style.position="absolute";
        gifImage.style.position="absolute";

        backgroundImage.style.zIndex=1;
        gifImage.style.zIndex=2;

        // Load background image
        var backgroundImageInput = document.getElementById("backgroundFileLoader");
        backgroundImageInput.onchange = function (event) {
            backgroundImage.src = URL.createObjectURL(event.target.files[0]);
        }

        // Load gif image
        var gifImageInput = document.getElementById("gifImageLoader");
        gifImageInput.onchange = function (event) {
            gifImage.src = URL.createObjectURL(event.target.files[0]);
        }

        // Moving elements on click part
        var imageElements = document.getElementsByClassName("image");
        var selectedElement = null;

        for (var i = 0; i < imageElements.length; i++) {

            // Mouse click events
            imageElements[i].onclick = function (event) {
                if(selectedElement === event.target) {
                    selectedElement = null;
                }
                else {
                    selectedElement = event.target;
                }
                console.log(selectedElement);

                window.onmousemove = function (eventMouseMove) {
                    if (selectedElement != null) {
                        selectedElement.style.left = selectedElement.getBoundingClientRect().left + eventMouseMove.movementX + "px";
                        selectedElement.style.top = selectedElement.getBoundingClientRect().top + eventMouseMove.movementY + "px";
                    }
                };

            };

            // Click events
            imageElements[i].addEventListener("touchstart", function (touchstartEvent) {
                document.body.style.touchAction = "none";
                touchstartEvent.preventDefault();

                selectedElement = touchstartEvent.target;

                var previousTouchX = touchstartEvent.touches[0].clientX;
                var previousTouchY = touchstartEvent.touches[0].clientY;
                selectedElement.ontouchmove = (touchmoveEvent) => {
                    touchmoveEvent.preventDefault();
                    document.body.style.touchAction = "none";
                    var currentTouchX = touchmoveEvent.touches[0].clientX;
                    var currentTouchY = touchmoveEvent.touches[0].clientY;

                    var moveX = currentTouchX - previousTouchX;
                    var moveY = currentTouchY - previousTouchY;

                    selectedElement.style.left = selectedElement.getBoundingClientRect().left + moveX + "px";
                    selectedElement.style.top = selectedElement.getBoundingClientRect().top + moveY + "px";

                    previousTouchX = currentTouchX;
                    previousTouchY = currentTouchY;
                }

                selectedElement.addEventListener("touchend", function (touchendEvent){
                    selectedElement = null;
                    document.body.style.touchAction = "auto";
                });
            });
        }


        // Uploading form part
        /*var formElement = document.getElementById("imageForm");
        formElement.onsubmit = function (event) {
            var gifStartingX = gifImage.getBoundingClientRect().left - backgroundImage.getBoundingClientRect().left;
            var gifStartingY = gifImage.getBoundingClientRect().top - backgroundImage.getBoundingClientRect().top;

            var gifStartingXInput = document.getElementById("gifStartingX");
            var gifStartingYInput = document.getElementById("gifStartingY");

            gifStartingXInput.value = parseInt(gifStartingX);
            gifStartingYInput.value = parseInt(gifStartingY);
        }*/
        
        // Under Constrction
        document.getElementById("generate").onclick = function generateImg() {
            var gifStartingX = gifImage.getBoundingClientRect().left - backgroundImage.getBoundingClientRect().left;
            var gifStartingY = gifImage.getBoundingClientRect().top - backgroundImage.getBoundingClientRect().top;

            var gifStartingXInput = document.getElementById("gifStartingX");
            var gifStartingYInput = document.getElementById("gifStartingY");

            gifStartingXInput.value = parseInt(gifStartingX);
            gifStartingYInput.value = parseInt(gifStartingY);
        };

    });
</script>
</html>